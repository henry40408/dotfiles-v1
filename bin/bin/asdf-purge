#!/usr/bin/env ruby

require 'fileutils'

all_plugins = []
all_versions = []

open(File.expand_path('~/.tool-versions')) do |file|
  file.each do |line|
    plugin, *versions = line.split(/\s+/)
    all_plugins << plugin
    versions.each do |version|
      all_versions << [plugin, version]
    end
  end
end

Dir[File.expand_path("~/.asdf/installs/*")].each do |dir|
  plugin = File.basename(dir)
  if all_plugins.include?(plugin)
    versions = Dir.entries(dir).select{ |version| !%w[. ..].include?(version) }
    versions.each do |version|
      next if all_versions.include?([plugin, version])
      full_path = File.expand_path("~/.asdf/installs/#{plugin}/#{version}")
      FileUtils.remove_dir(full_path)
      puts full_path
    end
  else
    FileUtils.remove_dir(dir)
    puts dir
  end
end
